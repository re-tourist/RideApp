# 项目开发现状总览（PROJECT_STATUS.md）

- 读者：项目组成员、助教/老师、后续接手者、协作 AI
- 目标：10 分钟读完，理解项目现状、代码位置、如何运行、关键实现、问题与优化计划

## 目录

- [A. 项目一句话介绍 & 当前里程碑](#a-项目一句话介绍--当前里程碑)
- [B. 快速开始](#b-快速开始)
- [C. 仓库文件结构总览](#c-仓库文件结构总览)
- [D. 架构与数据流](#d-架构与数据流)
- [E. 模块级现状盘点](#e-模块级现状盘点)
- [F. 接口与数据模型对齐情况](#f-接口与数据模型对齐情况)
- [G. 性能与体验现状](#g-性能与体验现状)
- [H. 测试与联调现状](#h-测试与联调现状)
- [I. 下一步计划](#i-下一步计划)

## A. 项目一句话介绍 & 当前里程碑

- 一句话介绍：RideFlow 是面向骑行者的移动应用，基于 Android Jetpack Compose 构建前端，当前版本直接通过 JDBC 连接云端 MySQL 获取与更新数据（暂未接入后端 REST 服务）。

| 模块 | 目标 | 当前进度 | 负责人 | 风险 |
|---|---|---|---|---|
| 用户/登录注册 | 登录/注册/资料读取 | 已完成（客户端直连数据库） | (推测) 前端 | 高风险：直连 DB、密码校验需严谨 |
| 个人主页详情 | 展示用户头像/昵称/简介与消息入口 | 已完成 | 前端 | 依赖 DB 可用性 |
| 骑行记录 | 列表与统计、骑行中数据采集 | 部分完成（记录展示，采集服务示例） | 前端 | 权限、前台服务与地图兼容 |
| 地图与轨迹 | AMap2D 地图显示与标记 | 已完成（示例） | 前端 | API Key、生命周期管理 |
| 社区动态 | 列表、帖子详情、俱乐部入口 | 已完成（含缓存） | 前端 | 直连 DB 的并发与稳定性 |
| 活动/赛事 | 列表与详情 | 部分完成 | 前端 | 数据一致性与分页 |
| 俱乐部 | 列表、详情、设置主俱乐部 | 部分完成 | 前端 | 权限与成员管理欠缺 |
| 商城/二手交易 | 社区交易展示 | 部分完成 | 前端 | 仅前端展示，无交易闭环 |
| 消息/通知 | 聊天页（示例数据） | 部分完成（示例） | 前端 | 未联调真实消息系统 |
| 设置/隐私/权限 | 权限申请与偏好 | 部分完成 | 前端 | 未系统化覆盖 |
| 后端服务 | Spring Boot REST | 未开始 | 后端 | 高风险：目前客户端直连数据库 |

## B. 快速开始

- 环境依赖
  - Android Studio（Koala+）、Gradle、JDK 17（建议）
  - MySQL（云端可访问）；当前连接通过 `DatabaseHelper` 直接使用 JDBC
- 启动 Android
  - 打开项目并运行 `MainActivity`，应用导航由 `AppNavGraph` 管理：`app/src/main/java/com/example/rideflow/MainActivity.kt:173`
  - 重要权限：定位、前台服务；需在设备授权
  - 地图：AMap2D（在 `RideScreen` 中使用），需正确配置 API Key（Manifest 与初始化），具体可参考设计文档
- 启动后端
  - 未提供后端 Spring Boot；当前客户端直连云端 MySQL（临时方案，需替换）
- 数据库连接（当前实际使用）
  - `app/src/main/java/com/example/rideflow/backend/DatabaseHelper.kt:10` 指向 `jdbc:mysql://101.37.79.220:3306/rideapp`（含用户名与密码）
  - 安全风险高：建议尽快迁移到后端 API + 安全认证
- 常见启动失败排查
  - 缺少定位权限或未开启位置服务
  - 未创建或未设置 AMap API Key，地图初始化失败
  - MySQL 网络不可达或被防火墙/白名单限制
  - JDBC 驱动类不匹配（当前使用 `com.mysql.jdbc.Driver`，建议 `com.mysql.cj.jdbc.Driver`）
  - 直连 DB 发生超时（`connectTimeout`/`socketTimeout`）
  - 云端数据库表结构与客户端查询不一致
  - Android 设备电池优化关闭前台服务导致采集中断
  - 依赖未同步，Gradle 构建失败
  - Compose 预览无法运行（需使用运行设备调试）
  - 低版本设备兼容性（通知渠道、前台服务类型）

## C. 仓库文件结构总览

```
app/
  src/main/java/com/example/rideflow/
    auth/                      # 登录注册仓库与 ViewModel
    backend/                   # JDBC 工具与认证数据库封装
    navigation/                # 应用导航图与路由常量
    profile/                   # Profile 仓库与 ViewModel
    services/                  # 前台服务：RideTrackingService
    ui/components/             # 复用 UI 组件（社区等）
    ui/screens/                # 所有页面（骑行/发现/社区/我的/详情等）
    ui/screens/community/      # 社区相关页面与详情
    model/                     # 数据模型（UserData 等）
  参考/rideapp.sql             # 数据库脚本与表结构

docs/
  设计文档/                    # 前端开发说明、页面设计、项目结构概览
  Prompt/                     # 文档生成与设计提示
  项目文档/RideFlow - 详细设计文档.docx
```

- 最常改动目录：`app/src/main/java/com/example/rideflow/ui/screens/`、`navigation/`、`backend/`
- 危险目录（改动易出问题）：`backend/DatabaseHelper.kt`（直连数据库配置）、`navigation/AppNavGraph.kt`
- 可清理目录：短期无明显冗余；建议统一模拟数据位置，避免散落在页面中

## D. 架构与数据流

- 客户端架构
  - UI：Jetpack Compose（`ui/screens`、`ui/components`）
  - ViewModel：`auth`、`profile` 等模块下管理状态
  - Repository：`AuthRepository`、`ProfileRepository` 等
  - 数据层：`backend/DatabaseHelper`（JDBC 工具）与 `AuthDatabaseHelper`
  - LocalCache：社区首页使用 `SharedPreferences` 缓存首屏数据
- 端到端数据流示例
  - 示例 1：登录/注册链路
    - UI：`LoginScreen`/`RegisterScreen`
    - ViewModel/Repo：`auth/AuthViewModel` → `auth/AuthRepository`
    - 数据访问：`backend/AuthDatabaseHelper.login/register` → `backend/DatabaseHelper`
    - 查询/更新：`users` 表（登录校验、最后登录时间更新）：`app/src/main/java/com/example/rideflow/backend/AuthDatabaseHelper.kt:21`、`:110`、`:150`
  - 示例 2：骑行记录列表链路
    - UI：`RideRecordScreen` 展示记录 + 月度汇总：`app/src/main/java/com/example/rideflow/ui/screens/RideRecordScreen.kt:69`
    - 数据访问：`DatabaseHelper.processQuery` 查询 `user_ride_records` 列表与 SUM 统计
    - 地图与采集：`RideScreen` 中地图展示与定位采集，前台服务 `RideTrackingService` 示例：`app/src/main/java/com/example/rideflow/services/RideTrackingService.kt:1`

## E. 模块级现状盘点

### 模块：用户/登录注册/个人资料

- 功能范围：登录、注册、资料读取与编辑、个人主页展示
- 关键页面/接口：`LoginScreen`、`RegisterScreen`、`ProfileScreen`、`ProfileDetailScreen`、`EditProfileScreen`、`UserProfileDetailScreen`
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/auth/AuthRepository.kt`：认证仓库
  - `app/src/main/java/com/example/rideflow/backend/AuthDatabaseHelper.kt`：登录/注册/资料查询（含密码哈希校验）
  - `app/src/main/java/com/example/rideflow/profile/ProfileRepository.kt`：资料仓库
  - `app/src/main/java/com/example/rideflow/ui/screens/ProfileScreen.kt`：个人主页
  - `app/src/main/java/com/example/rideflow/ui/screens/ProfileDetailScreen.kt`：资料详情与 `UserProfileDetailScreen`
- 关键实现方法：
  - 登录支持邮箱/昵称，`users.status=0` 过滤；更新 `last_login_at`
  - `DatabaseHelper` 提供 `querySingleRow/MultipleRows/SingleValue/executeUpdate`
  - 头像/昵称/简介渲染，消息 CTA 跳转 `chat/{userId}`
- 当前完成度：已完成（前端直连 DB）
- 已知问题/风险：直连 DB；密码哈希与校验需严格；异常处理与错误提示待完善
- 优化建议：改造为后端 API；封装统一 `ApiResult`；增加失败态与骨架屏

### 模块：骑行记录（开始/暂停/结束/轨迹/GPS）

- 功能范围：骑行中数据采集、地图显示、历史记录与统计
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/RideScreen.kt`：定位与地图、状态切换、UI 展示
  - `app/src/main/java/com/example/rideflow/services/RideTrackingService.kt`：前台服务示例
  - `app/src/main/java/com/example/rideflow/ui/screens/RideRecordScreen.kt`：记录列表与月度汇总
- 关键实现方法：
  - FusedLocationProvider 定位；Amap2D 地图标记与相机移动；速度/距离/均速计算
  - 记录列表与月度 SUM 统计源自 `user_ride_records`
- 当前完成度：部分完成（前台服务示例、采集/落盘未与 DB 打通）
- 已知问题/风险：定位权限、前台服务、地图生命周期；性能与电池优化
- 优化建议：落盘采集到本地或后端；分页加载记录；地图更新节流

### 模块：路线/路书（创建/收藏/导航）

- 功能范围：路书详情浏览与跳转入口
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/DiscoverScreen.kt`：分类入口（路书）
  - `app/src/main/java/com/example/rideflow/navigation/AppNavGraph.kt`：`ROUTE_DETAIL/{id}` 路由
- 当前完成度：部分完成（入口与详情页链接存在，页面实现待完善）
- 优化建议：引入路书数据模型；收藏/分享；地图导航路线绘制

### 模块：社区动态（发帖/点赞/评论/关注）

- 功能范围：动态列表、作者头像点击到俱乐部/用户主页、帖子详情、缓存与分页
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/community/CommunityScreen.kt`：社区首页与缓存
  - `app/src/main/java/com/example/rideflow/ui/screens/community/PostDetailScreen.kt`：帖子详情
  - `app/src/main/java/com/example/rideflow/ui/screens/community/CommunityClubDetail.kt`：俱乐部动态与详情
  - `app/src/main/java/com/example/rideflow/ui/components/CommunityComponents.kt`：社区组件
- 关键实现方法：
  - 首页首屏缓存：`SharedPreferences` + Base64 编码，最多 40 条：`CommunityScreen.kt:354`、`:371`、`:393`
  - 点赞集合用于 UI 初始态：`CommunityScreen.kt:340`
  - 头像点击行为：`onAvatarClick` 区分俱乐部/用户：`CommunityScreen.kt:190`
  - 帖子详情作者名优先俱乐部名：`PostDetailScreen.kt:54`
- 当前完成度：已完成（含缓存与详情）
- 已知问题/风险：缓存字段不全、解析脆弱；分页与加载更多逻辑需加强
- 优化建议：改为 JSON+TTL+版本号缓存；统一分页 API；异常与重试策略

### 模块：活动/赛事（列表/详情/报名）

- 功能范围：活动/赛事列表与详情展示、报名入口（部分）
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/RaceScreen.kt`、`RaceDetailScreen.kt`
  - `app/src/main/java/com/example/rideflow/ui/screens/ActivitiesScreen.kt`、`ActivityDetailScreen.kt`
  - `app/src/main/java/com/example/rideflow/navigation/AppNavGraph.kt`：`RACE`、`CREATE_RACE`、`ACTIVITIES`、`ACTIVITY_DETAIL/{id}` 路由
- 关键实现方法：
  - 列表与详情从 DB 查询；标签 `race_tags` 合并：`RaceScreen.kt:46`、`RaceDetailScreen.kt:68`
- 当前完成度：部分完成
- 优化建议：报名与收藏联动；分页与筛选；统一数据模型

### 模块：俱乐部（创建/加入/成员管理）

- 功能范围：俱乐部列表与详情、设置主俱乐部、社区俱乐部动态
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/ClubScreen.kt`、`ClubDetailScreen.kt`、`SetMainClubScreen.kt`
  - `app/src/main/java/com/example/rideflow/navigation/AppNavGraph.kt`：`CLUB_SCREEN`、`CLUB_DETAIL/{id}`、`SET_MAIN_CLUB`
  - `app/src/main/java/com/example/rideflow/ui/screens/community/CommunityClubDetail.kt`
- 当前完成度：部分完成（详情与社区动态已接通，成员管理/申请/审批为示意）
- 优化建议：接入成员与审批 API；统一 CTA 与权限判断

### 模块：商城/二手交易

- 功能范围：社区交易展示
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/community/CommunityTrade.kt`
  - `app/src/main/java/com/example/rideflow/navigation/AppRoutes.kt`：`TRADE_DETAIL/{id}` 路由
- 当前完成度：部分完成（列表展示与详情入口）
- 优化建议：接入真实交易平台或自有后端；增加筛选与安全防护

### 模块：消息/通知

- 功能范围：聊天页示例
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/ProfileDetailScreen.kt`：`ChatScreen`
- 当前完成度：部分完成（示例数据）
- 优化建议：接入通知与消息服务；统一会话模型

### 模块：设置/隐私/权限

- 功能范围：权限申请、偏好设置及隐私相关
- 关键文件清单：
  - `app/src/main/java/com/example/rideflow/ui/screens/ProfileScreen.kt`（设置入口与偏好）
- 当前完成度：部分完成
- 优化建议：统一权限与隐私策略；偏好项落盘与同步

## F. 接口与数据模型对齐情况

- 后端 REST：未提供；客户端直接访问数据库
- 数据表（示例，详见 `app/参考/rideapp.sql`）
  - `users`：用户信息（登录、资料、头像、简介等）
  - `user_ride_records`：骑行记录（时间、距离、均速等）
  - `races`、`race_tags`：赛事与标签
  - `activities`：活动
  - `community_posts`、`post_likes`、`post_comments`：社区动态与互动
  - `clubs`：俱乐部信息
- 字段一致性检查（示例）
  - 登录查询字段与 `users` 表匹配：`AuthDatabaseHelper.login`（`user_id/nickname/email/password_hash/...`）
  - 骑行记录列表使用 `user_ride_records` 字段：`RideRecordScreen` 查询与 SUM 合计
  - 社区帖子详情作者名优先俱乐部名：`PostDetailScreen` 联表查询 `clubs` 与 `users`

## G. 性能与体验现状

- 现状与证据
  - 直连数据库，页面加载依赖网络与 SQL，可能导致首屏慢（`CommunityScreen` 首屏缓存作为补救）
  - 地图与定位存在生命周期与权限复杂性（`RideScreen` 中大量生命周期控制与节流）
- 优化路线
  - P0（立即见效）：
    - 首屏缓存 JSON+TTL 改造（替代 Base64+管道分隔）
    - 异步加载与骨架屏；并发拉取点赞、评论、头像等数据后再合并
    - 分页与加载更多明确边界，减少一次性加载
  - P1（结构调整）：
    - 数据层改造为后端 REST；客户端不再直连 DB
    - 统一状态流（ViewModel + Repository + Result 封装）；错误态与重试策略
  - P2（工程化）：
    - 性能监控与基准（冷启动/滚动）；CI 集成 Lint/ktlint/detekt
    - 安全整改：移除明文 DB 凭证，OAuth/JWT 接入

## H. 测试与联调现状

- 当前测试：暂无系统化单元/UI/接口测试
- 联调方式：直接数据库查询、日志观察、真机/模拟器手测
- 最小可行测试集（示例 10 条）
  - 登录成功/失败（邮箱/昵称）；锁定/禁用用户
  - 注册重复邮箱/昵称校验与成功注册
  - 个人主页资料加载与空值处理
  - 骑行记录列表加载与月度 SUM 统计正确性
  - 地图定位权限缺失时的降级行为与默认坐标
  - 社区首屏缓存读写（版本与字段扩展）
  - 帖子详情作者名与评论列表加载
  - 俱乐部详情加载与动态列表合并点赞/评论计数
  - 活动/赛事详情字段展示与标签合并
  - 权限与前台服务启动/停止的稳定性

## I. 下一步计划

| 任务 | 目标 | 涉及文件 | 预估难度 | 风险 |
|---|---|---|---|---|
| 引入后端 REST 层 | 取代直连 DB，统一接口与鉴权 | backend/* → server | L | 安全与架构变更 |
| 移除明文 DB 凭证 | 使用安全配置与服务端代理 | backend/DatabaseHelper.kt | S | 连接不可用风险 |
| 社区缓存改造 | JSON+TTL+版本号，补充头像与点赞状态 | CommunityScreen.kt | M | 兼容老缓存 |
| 统一分页与加载更多 | 所有列表统一分页参数与 UI | ui/screens/* | M | 联动广泛 |
| 地图与定位稳定性 | 生命周期与节流优化，权限引导 | RideScreen.kt | M | 机型差异 |
| 骑行数据落盘链路 | 前台服务 → 本地/后端落盘与同步 | RideTrackingService.kt | L | 数据一致性 |
| 错误态与骨架屏 | 统一 Result 封装与占位 | ui/components/* | S | 风险较低 |
| 性能基准与监控 | 冷启动/滚动指标与优化闭环 | build/CI | M | 工程投入 |
| 测试集与 CI | 单元/UI/接口测试与持续集成 | tests/* | M | 初期成本 |
| UI/UX一致性 | 统一 CTA 布局与文案，提升一致性 | ui/screens/* | S | 需要设计对齐 |

—— 完 ——

